<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CurlingStone BLE Demo</title>
</head>
<body>
  <h1>BLE CurlingStone Stats</h1>
  <button id="connectButton">Connect to CurlingStone</button>
  
  <h2>Extra Distance: <span id="distanceValue">--</span></h2>
  <h2>Extra Curl: <span id="curlValue">--</span></h2>
  
  <script>
    // DOM elements for displaying values
    const connectBtn = document.getElementById('connectButton');
    const distanceSpan = document.getElementById('distanceValue');
    const curlSpan = document.getElementById('curlValue');
    
    // Bluetooth UUIDs
    // Service "180C" is used in your code.
    // Characteristics "2A6E" (extraDistance) and "2A6F" (extraCurl).
    const SERVICE_UUID = 0x180C;    // or "0000180c-0000-1000-8000-00805f9b34fb"
    const DISTANCE_CHAR_UUID = 0x2A6E;
    const CURL_CHAR_UUID = 0x2A6F;
    
    let bleDevice;
    let bleServer;
    let distanceCharacteristic;
    let curlCharacteristic;
    
    connectBtn.addEventListener('click', async () => {
      try {
        // Request the BLE device by name (or filter by service).
        // The Arduino advertises localName = "CurlingStone".
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ name: "CurlingStone" }],
          optionalServices: [SERVICE_UUID]
        });
        
        console.log("Device selected:", bleDevice.name);
        
        // Connect GATT
        bleServer = await bleDevice.gatt.connect();
        console.log("GATT connected to", bleDevice.name);
        
        // Get the primary service
        const service = await bleServer.getPrimaryService(SERVICE_UUID);
        
        // Get characteristics
        distanceCharacteristic = await service.getCharacteristic(DISTANCE_CHAR_UUID);
        curlCharacteristic = await service.getCharacteristic(CURL_CHAR_UUID);
        
        // Listen for notifications on each characteristic
        distanceCharacteristic.addEventListener('characteristicvaluechanged', handleDistance);
        curlCharacteristic.addEventListener('characteristicvaluechanged', handleCurl);
        
        // Start notifications
        await distanceCharacteristic.startNotifications();
        await curlCharacteristic.startNotifications();
        
        console.log("Notifications started on Distance & Curl characteristics.");
        
      } catch (error) {
        console.error("Error connecting to BLE device:", error);
      }
    });
    
    // Parse 4 bytes as a 32-bit float, little-endian
    function getFloat32Value(dataView) {
      return dataView.getFloat32(0, true);
    }
    
    // Handle distance notifications
    function handleDistance(event) {
      const value = event.target.value; // DataView
      const distance = getFloat32Value(value);
      distanceSpan.textContent = distance.toFixed(2);
      console.log("Extra Distance:", distance);
    }
    
    // Handle curl notifications
    function handleCurl(event) {
      const value = event.target.value; // DataView
      const curl = getFloat32Value(value);
      curlSpan.textContent = curl.toFixed(2);
      console.log("Extra Curl:", curl);
    }
  </script>
</body>
</html>
